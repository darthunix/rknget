Краткая документация по проекту

Предисловие

Основной целью создания набора программ является переход от наколенных скриптов к полноценной системе, в которой можно отслеживать все ситуации, исключения и ошибки как со стороны провайдера, так и со стороны ведомства. Данный проект позволил существенно уменьшить риски судебных разбирательств и штрафов, а также улучшить мониторинг работы сетевых сервисов в условиях постоянного реконфигурирования.

Источником данных является файл дампа, скачиваемый через сервис выгрузок РКН. Он разбирается и заносится в базу данных, из которой затем другие программы забирают нужную им информацию через вебсервис. База данных является отражением дампа со всей его информацией, проверенной на корректность и конвертированной в корректную кодировку. С одной стороны, данные инкрементальны, т.е. можно отследить, когда они появились в дампе. С другой, существует жёсткая привязка к уникальному id и hash записи контента, а он может меняться, и это отследить нельзя. Точнее, можно было бы, но это привело бы к чрезмерному распуханию базы, особенно в приступах буйства нашего ведомства. 

Таблицы

0. dumpinfo - соответствует корневому тегу, содержит информацию о последнем удачно спарсенном дампе.
1. content - соответствует тегу content и его полям, outer_id - это уникальный id записи из дампа.
2. blocktype - тип блокировки контента из дампа, согласно документации по выгрузке.
3. decision - решение организации о блокировке.
4. organisation - данные по организацииб, ведомству.
5. entrytype - таблица реестров, согласно документации по выгрузке; статичный справочник.
6. resource - таблица ресурсов, отсюда API берёт все данные.
7. entitytype - тип ресурса, схож с blocktype, но вывставляется на основе тега и обрабатываемых данных.
8. log - служебная таблица, в которой отслеживаются программы, работающие с данными.

Программы

0. Общие принципы работы программ

Каждая из программ имеет своё утилитарное назначение, но все они работают по одному и тому же принципу:
a) Обращение к БД идёт через WEB API, без него работать ничего не будет.
b) Создаётся PID-запись в БД с именем программы. Это позволяет избежать двойного проникновения с последующим развратом. Если вам необходимо запускать несколько одинаковых экземпляров программ, просто поменяйте имя исполняемого файла, либо поставьте forcerun=True в файле конфигурации.
c) По окончании работы программа записывает код возврата и краткий результат работы в таблицу log.
d) Для работы по расписанию создайте запись в cron. Не забудьте сделать файл исполняемым и позаботьтесь о путях.

1. common

Библиотеки, содержащие функции, используемые большинством рабочих программ.
Не требуются для вебсервера.
webconn требуется всеми программами для работы с web api.
В качестве аргументов принимает кучу параметров вебсервера (описано в комментариях), обязательные параметры module и metho, а также kwargs в качестве параметров вызова функции на "той стороне".
Вызов WEB API выглядит следующим образом:
parse_result = webconn.call(module='api.dumpparse',
                            method='parse',
                            xmldump=xmldump,
                            **config['API'])
В данном случае на сервере вызывается функция parse(xmldump, connstr) модуля api.dumpparse, где connstr прописан в конфигурации WEB API, а параметр xmldump, как и прочие параметры вызова функции, передаются посредством CGI.
Получаемые данные вебсервера парсятся и возвращаются функцией.

2. rkn

2.1. api

Модули, работающие с классами БД.
dbutils - утилиты для сырой работы с БД (используются rkncli)
parseutils - модуль утилит.
Является уровнем абстракции над базой данных: БД возвращает сырые данные, API -годные. Хотя иногда всё не так или проще.
Любой модуль после импорта может работать индивидуально прямо с базой, если передать функции строку подключения к БД (connstr).


2.2. db

Модули, работающие напрямую с БД.
Используют библиотеку SQL Alchemy.
scheme.py - ORM базы данных.

2.3.
dbconn - конфигурация подключения к БД.
webapi, webjsonapi - примитивные программы, преобразующие входящие параметры вызовы модулей и их функций.
Первый работает с Content-Type: text/plain, второй - с Content-type:application/json.
JSON WEB API используется во всех программах и желателен.
PLAIN WEB API удобен для доступа к данным по ссылке через GET.

Запрос должен быть представлен в виде словаря со следующими записями:
module - путь модуля относительно программы WEB API
method - имя функции
params - параметры функции, кроме connstr (он подгружается из dbconn)

Пример GET-запроса:
http://z-test-rkn/cgi-bin/rknget/rkn/webapi.py?module=api.restrictions&method=getBlockedIPs&collapse=False

Для упрощения доступа к WEB API программы используют модуль webconn, о котором написано выше.

3. config.xml

У каждой программы имеется свой YAML-файл конфигурации.
Его можно указать ключём -c, либо по умолчанию используется config.yml в каталоге исполнения.

Типичные разделы конфигурации:

Global: - общие параметры
  tmppath: - путь к временным файлам, создаётся при запуске, если отсутствует.
  forcerun: - принудительное выполнение, несмотря на работающие копии.
  saveconf: - сохранить генерируемые (-ые) конфигурацию (-ии).

API: - параметры доступа к WEB API, без них программа работать не будет
  host: - хост
  port: - порт веб службы
  url: - путь к программе WEB API
  secure: - использовать TLS или нет
  timeout: - таймаут HTTP-сессии

Logging: - параметры логирования
  logpath: - путь к файлу лога
  stdoutlvl: - уровень детализации stdout-лога
  logfilelvl: уровень детализации файлового лога

5. rkn-bird

Программа, реализующая блокировки по IP и IP Subnet.
Создаёт дополнение к конфигурации bird, чтобы тот делал BGP-анонсы маршрутов на граничные маршрутизаторы

Разделы конфигурации:

Bird:
  restartcmd: - команда рестарта демона
  confpath: - путь генерируемой конфигурации, которую директивой include подключит демон после перезапуска
  collapse: - удалять дублируемые ip/подсети, поглащать ip их подсетями, объединять смежные подсети и ip в подсети
  stubip: - IP адрес заглушки, куда будут маршрутизироваться анонсируемые подсети

5. rkn-f5

Программа, реализующая блокировки по HTTP URL.
Формирует JSON-конфигурацию для datagroup и отсылает её на F5 через WEB API.

Разделы конфигурацииdumpinfo:

F5:
  - host: - хост
    port: - порт API F5
    secure: - использовать TLS или нет
    datagroup: - имя datagroup на F5
    user: - пользователь
    password: - пароль
    timeout: - таймаут; F5 рвёт сессию по истечении 120 секунд
  - host: - следующий хост в списке, со своими параметрами, и так далее

Так как АС Ревизор делает проверки при помощи curl http://resource, его можно перехитрить, блокируя ip и domain только по HTTP.
Например, вот так http://192.0.2.253
Этот функционал реализован для избежания ситуаций, когда, например, ресурс блокируется по DNS (как положено в документации на сайте РКН), а Ревизор делает curl -H 'Host: example.org' http://192.0.2.253, получает HTTP 200 OK и рапортует о нарушении.
Помните, что корректность работы не гарантирована априори. Используйте на свой страх и риск.

Extra:
  https: - добавить https urls в список
  ip: - добавить ip в список
  ipsubnet: - добавить все хосты ip подсетей в список; осторожно, их может быть очень много!
  domain: - добавить домены в список
  domain-mask: - добавить домены без *. в список (субдомены авторы "Ревизора" проверять не стали)
  truncate-after: 200000 - ограничить список выгрузки в F5 данным числом записей; на случай, если вдруг получилось слишком много, и это может сломать железные прокси.

6. rkn-unbound

Программа, реализующая блокировки по domain и domain-mask.
В режиме онлайн обращается к демону unbound через unbound-control, загружая и выгружая зоны, не теряя кэша DNS-рекурсера. Генерирует дополнение к конфигурации unbound, которую подгружает основной conf-файл через директиву include.
Согласно документации, для доменов создаёт зону transparent, для wildcard-доменов - зону redirect.
Может работь без root привилегий, если дать доступ пользователю, от имени которого запускается модуль, доступ к сертификатам аутентификации в /etc/unbound (unbound_control.key, unbound_control.pem).  

Разделы конфигурации:

Unbound:
  binarypath: - путь к unbound-control
  confpath: - путь генерируемой конфигурации, которую директивой include подключит демон после перезапуска 
  collapse: - удалять домены, которые перекрываются wildcard-доменами
  stubip: 10.1.1.3 - IP-адрес, в который разрешаются блокируемые домены

7. rknget

Программа, переводящая дамп в БД.
Требует для работы 2 файла: request.xml (файл с данными организации) и request.xml.sig (контейнер цифровой подписи).
Осуществляет загрузку XML-дампа с сервиса выгрузок РКН, его парсинг, импорт в БД и блокировку ресурсов.

rknsoapwrapper - модуль класса доступа к SOAP API службы выгрузок. Используется проверки актуальности дампа выгрузки, его затребования и скачивания с сервиса выгрузок. 

Разделы конфигурации:

Global:
  savedump: - сохранять ли загруженный дамп в dumpPath
  dumpPath: - путь к дампу
  reqPath: - путь к request.xml
  reqPathSig: - путь к request.xml.sig

DumpLoader:
  url: путь к WSDL API РКН
  retrycount: - количество попыток загрузки дампа
  conntimeout: - таймаут соединения
  sleeptimeout: - таймаут сна перед очередной попыткой загрузки 
  SoapVersion: - версия SOAP
  dumpfmtver: - версия выгружаемого дампа

По умолчанию программа честно выставляет признак блокировки ресурсам согласно их blocktype в дампе; чаще всего этого не достаточно, особенно учитывая принцип работы АС Ревизор. Для этого применяется дополнительная блокировка ресурсов, связанных в рамках одной записи content.
Например: [https, domain] означает, что если ресурс(ы) записи следует блокировать по https, то заодно будут заблокированы все domain ресурсы этой же записи.

Blocking:
  - [src, dst]
  - [src, dst]
  ...

Miscellaneous:
  custom: True - Блокировать ресурсы, добавленные пользователем 
  uselocaldump: False - Парсить локальный дамп в dumpPath, а не скачивать с сервиса. Делитесь дампами, не стесняйтесь.

8. rkngetdirect

Аналог rknget, работающий с БД напрямую.
Работает быстрее и потребляет в 3 раза меньше памяти.
Удобен для установки all-in-one, на одном сервере с этим скриптом будут находиться БД и WEB API.
Требует каталог rkn со всем API, лежащий рядом с каталогом программы.

Также нуждается в модуле rknsoapwrapper.

9. rkncli

Утилита командной строки (CLI).
В отличие от других программ, не создаёт PID-запись в базе данных.
Не ведёт лог. Не создаёт путей.
По сути, делает простой парсинг аргументов в вызов WEB API.
Использует функции api.dbutils, которые возвращают plain text для вывода в терминал.
Часто использует в качестве ключа content.outer_id - это id записей content из дампа.

./rkncli.py - показывает подробную справку и каркас аргументов

./rkncli.py --help - показывает краткую справку

При наличии config.yml с разделом API не нужждается в аргументе -c (см. раздел 3).
Во избежание выстрела в ногу использует безопасные функции:
content del - удаляет запись content вместе с ресурсами
content get - показывает данные content по outer_id, со всеми зависимыми ресурсами (опционально)

dumpinfo show - показывает данные последнего удачного парсинга
dumpinfo stats - показывает данные по ресурсам

resource add entitytype value - создаёт дополнительный ресурс
resource del entitytype value - удаляет дополнительный ресурс
resource find entitytype, value [all|columns] - ищет все ресурсы по вхождению субстроки в value, отображает заданные колонки, но не более, чем в all
